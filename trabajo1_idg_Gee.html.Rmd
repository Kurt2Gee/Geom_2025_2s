```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org"))
```

---
title: "Diferencia de densidad de poblacion y poblacion de tercera edad"
author: "Kurt Gee Castañer"
date: "2025-10-17"
output: html_document
---

# 1.Introducción

Este documento presenta un flujo de trabajo reproducible en R para el análisis geoespacial de indicadores demográficos en seis comunas de la Región de Valparaíso, Chile. Utilizando una combinación de consultas SQL sobre una base de datos PostgreSQL, procesamiento estadístico con dplyr, y visualización cartográfica con ggplot2 y biscale, se construye un mapa bivariado que relaciona la densidad poblacional con la proporción de personas de tercera edad (60 años o más).

## 1.1. Objetivo general

El objetivo principal es generar una herramienta visual que permita identificar patrones territoriales relevantes para la planificación urbana, el diseño de políticas públicas y el análisis sociodemográfico. El flujo incluye validaciones robustas, integración de shapefiles oficiales, y una clasificación bivariada adaptativa según la distribución de los datos. Este enfoque puede ser escalado a otras comunas o indicadores, y está diseñado para ser automatizado y reutilizable en futuros análisis.

# 2.Desarrollo

## 2.1. Variables a utilizar

El análisis se desarrolló a partir de datos censales almacenados en una base de datos PostgreSQL, complementados con información geoespacial proveniente de un shapefile oficial de comunas. Se seleccionaron seis comunas de la Región de Valparaíso como unidades territoriales de estudio. A través de consultas SQL, se extrajeron variables individuales que luego fueron agregadas por comuna. Las principales variables utilizadas fueron:

-   p10comuna: código territorial de la comuna.
-   p08: sexo de la persona ('1' para hombres, '2' para mujeres).
-   p09: edad de la persona.

A partir de estas, se construyeron las siguientes variables derivadas: - comuna: código de comuna normalizado a cinco dígitos. - hombres: total de personas con sexo masculino. - mujeres: total de personas con sexo femenino. - total: suma de hombres y mujeres por comuna. - tercera_edad: número de personas con edad igual o superior a 60 años. - km2: superficie de cada comuna en kilómetros cuadrados. - densidad_total: indicador de densidad poblacional, calculado como total dividido por superficie. - bi_class: clasificación bivariada generada mediante la función bi_class() del paquete biscale.

Las fórmulas aplicadas fueron las siguientes:

\- Densidad poblacional

densidad_total = total / km2

\- Clasificación bivariada\
`bi_class(x = densidad_total, y = tercera_edad, style = "quantile", dim = dim_final)`

Esta clasificación permite representar simultáneamente dos variables en el mapa, facilitando la identificación de patrones territoriales conjuntos entre densidad poblacional y proporción de adultos mayores.

## 2.2. Metodología

### 2.2.1. Librería

```{r}
library(DBI)
library(RPostgres)
library(dplyr)
library(tibble)
library(stringr)
library(sf)
library(ggplot2)
library(biscale)

```

### 2.2.2. Conexión a PostgreSQL

```{r Conexión a PostgreSQL, echo=TRUE, message=FALSE, warning=FALSE}
tryCatch({
  con <- DBI::dbConnect(
    RPostgres::Postgres(),
    dbname = "Vregion",
    host = "localhost",
    port = 5432,
    user = "postgres",
    password = "Kurt12345*"
  )
  message("Conexión establecida correctamente.")
}, error = function(e) {
  message("No se pudo conectar a PostgreSQL: ", e$message)
})

### 2.2.3. Consultas SQL para las 6 comunas

comunas_seleccionadas <- c("5101", "5103", "5109", "5801", "5802", "5804")

# Conteo por sexo
sexo_df <- DBI::dbGetQuery(con, sprintf("
  SELECT 
    p10comuna AS comuna,
    SUM(CASE WHEN p08 = '1' THEN 1 ELSE 0 END) AS hombres,
    SUM(CASE WHEN p08 = '2' THEN 1 ELSE 0 END) AS mujeres
  FROM personas
  WHERE p10comuna IN (%s)
  GROUP BY p10comuna;
", paste0("'", comunas_seleccionadas, "'", collapse = ",")))

# Conteo de tercera edad (60+)
etario_df <- DBI::dbGetQuery(con, sprintf("
  SELECT 
    p10comuna AS comuna,
    SUM(CASE WHEN p09 >= 60 THEN 1 ELSE 0 END) AS tercera_edad
  FROM personas
  WHERE p10comuna IN (%s)
  GROUP BY p10comuna;
", paste0("'", comunas_seleccionadas, "'", collapse = ",")))

# Cerrar conexión
DBI::dbDisconnect(con)


### 2.2.4. Superficie por comuna (valores reales o aproximados)

superficie <- tibble(
  comuna = str_pad(comunas_seleccionadas, width = 5, pad = "0"),
  km2 = c(401.6, 76.0, 121.6, 536.9, 293.8, 96.5)
)
```

### 2.2.5. Procesar indicadores

```{r Procesar indicadores, message=FALSE, warning=FALSE}
sexo_df <- sexo_df %>% mutate(comuna = str_pad(as.character(comuna), width = 5, pad = "0"))
etario_df <- etario_df %>% mutate(comuna = str_pad(as.character(comuna), width = 5, pad = "0"))
superficie <- superficie %>% mutate(comuna = as.character(comuna))

densidad_df <- sexo_df %>%
  mutate(total = hombres + mujeres) %>%
  left_join(superficie, by = "comuna") %>%
  mutate(densidad_total = round(total / km2, 2)) %>%
  select(comuna, densidad_total)

etario_df <- etario_df %>%
  select(comuna, tercera_edad)
```

### 2.2.6. Cargar shapefile y corregir códigos

```{r Cargar shapefile y corregir códigos, echo=TRUE, message=FALSE, warning=FALSE}
ruta_shape <- "C:/Users/Kurta/Desktop/Universidad/Geomarketing/DPA/DPA_2023/COMUNAS/COMUNAS_v1.shp"
comunas <- st_read(ruta_shape)

comunas <- comunas %>%
  mutate(CUT_COM = str_pad(CUT_COM, width = 5, pad = "0"))

subset_comunas <- comunas %>%
  filter(CUT_COM %in% densidad_df$comuna) %>%
  left_join(densidad_df, by = c("CUT_COM" = "comuna")) %>%
  left_join(etario_df, by = c("CUT_COM" = "comuna"))

# Verificación
print("Verificación de datos unidos:")
print(subset_comunas %>% select(CUT_COM, densidad_total, tercera_edad))
```

### 2.2.7. Clasificación bivariada con validación robusta

```{r Clasificación bivariada con validación robusta, echo=TRUE, message=FALSE, warning=FALSE}
subset_comunas_clean <- subset_comunas %>%
  filter(!is.na(densidad_total) & !is.na(tercera_edad)) %>%
  mutate(
    densidad_total = as.numeric(densidad_total),
    tercera_edad = as.numeric(tercera_edad)
  )

n_densidad <- length(unique(na.omit(subset_comunas_clean$densidad_total)))
n_edad <- length(unique(na.omit(subset_comunas_clean$tercera_edad)))

dim_final <- if (n_densidad < 2 || n_edad < 2) {
  stop("No hay suficientes valores únicos para clasificar. Revisa los datos.")
} else if (n_densidad < 3 || n_edad < 3) {
  2
} else {
  3
}

subset_bi <- bi_class(
  subset_comunas_clean,
  x = densidad_total,
  y = tercera_edad,
  style = "quantile",
  dim = dim_final
)
```

### 2.2.8. Graficar mapa bivariado

```{r Graficar mapa bivariado, echo=TRUE, message=FALSE, warning=FALSE}
mapa <- ggplot() +
  geom_sf(data = subset_bi, aes(fill = bi_class), color = "white", size = 0.2) +
  bi_scale_fill(pal = "DkBlue", dim = dim_final) +
  labs(
    title = "Mapa bivariado: Densidad poblacional vs población de tercera edad",
    subtitle = "Valparaíso, Concón, Viña del Mar, Quilpué, Limache y Villa Alemana",
    caption = "Fuente: Censo 2017 + Shapefile DPA 2023"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    legend.position = "none"
  )

```

### 2.2.9.Leyenda bivariada

```{r Leyenda bivariada, echo=TRUE, message=FALSE, warning=FALSE}
leyenda <- bi_legend(
  pal = "DkBlue",
  dim = dim_final,
  xlab = "Mayor densidad poblacional ⟶",
  ylab = "↑ Mayor población de tercera edad",
  size = 7
)
```

### 2.2.10. Combinar mapa + leyenda

```{r Combinar mapa + leyenda, echo=TRUE, message=FALSE, warning=FALSE}
final <- cowplot::ggdraw() +
  cowplot::draw_plot(mapa, 0, 0, 1, 1) +
  cowplot::draw_plot(leyenda, 0.65, 0.05, 0.3, 0.3)

print(final)

```

## 2.3 Resultado

![](mapa_bivariado.png)

El mapa bivariado obtenido permite visualizar simultáneamente dos dimensiones demográficas relevantes en las comunas de Valparaíso, Concón, Viña del Mar, Quilpué, Limache y Villa Alemana: la densidad poblacional y la proporción de personas de tercera edad (60 años o más). Cada comuna fue clasificada según su posición relativa en ambas variables, utilizando cuantiles como criterio de segmentación. La escala de colores aplicada permite identificar combinaciones específicas: - Tonos más oscuros y saturados indican comunas con alta densidad poblacional y alta proporción de adultos mayores. - Tonos más claros representan comunas con baja densidad y baja proporción de tercera edad. - Las tonalidades intermedias reflejan combinaciones mixtas, como alta densidad con baja proporción de adultos mayores, o viceversa. Esta representación facilita la comparación territorial entre comunas y permite identificar zonas que podrían requerir atención diferenciada en términos de planificación urbana, servicios sociales, infraestructura y políticas públicas orientadas al envejecimiento poblacional. El mapa revela, por ejemplo, que comunas como Viña del Mar y Valparaíso presentan perfiles demográficos con alta densidad y una proporción significativa de adultos mayores, lo que podría implicar desafíos específicos en movilidad, salud y vivienda. En contraste, comunas como Limache o Concón muestran perfiles más dispersos o mixtos, lo que sugiere dinámicas territoriales distintas.

# 3.Conclusión

El análisis bivariado realizado sobre las comunas de la Región de Valparaíso permitió identificar patrones territoriales relevantes en la relación entre densidad poblacional y proporción de adultos mayores. La integración de datos censales con información geoespacial y la aplicación de una clasificación bivariada proporcionaron una herramienta visual efectiva para la interpretación conjunta de estos indicadores. Los resultados evidencian que ciertas comunas presentan simultáneamente alta densidad y envejecimiento poblacional, lo que puede implicar desafíos específicos en términos de infraestructura, servicios de salud, movilidad y planificación urbana. Por otro lado, comunas con menor densidad o menor proporción de adultos mayores podrían requerir estrategias diferenciadas. Este enfoque metodológico puede ser replicado para otros territorios o variables, y constituye una base sólida para el diseño de políticas públicas focalizadas, así como para la toma de decisiones informadas en el ámbito del desarrollo territorial.
